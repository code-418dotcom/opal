name: ðŸš€ Deploy Full Azure Stack (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_infra:
        description: 'Skip infrastructure deployment'
        required: false
        type: boolean
        default: false
      skip_backend:
        description: 'Skip backend services deployment'
        required: false
        type: boolean
        default: false
      skip_frontend:
        description: 'Skip frontend deployment'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  ENV_NAME: ${{ inputs.environment }}
  LOCATION: westeurope
  MONITORING_LOCATION: westeurope
  POSTGRES_LOCATION: northeurope
  RG_NAME: opal-${{ inputs.environment }}-rg
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ========================================
  # JOB 1: Deploy Infrastructure
  # ========================================
  deploy_infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_infra }}
    outputs:
      infra_deployed: ${{ steps.deploy_bicep.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          set -euo pipefail
          echo "Creating resource group: ${RG_NAME}"
          az group create --name "${RG_NAME}" --location "${LOCATION}" -o jsonc

      - name: Deploy Bicep Infrastructure
        id: deploy_bicep
        run: |
          set -euo pipefail

          echo "Installing jq..."
          sudo apt-get update
          sudo apt-get install -y jq

          echo "Preparing parameters..."
          jq '.parameters.postgresAdminPassword.value = "${{ secrets.POSTGRES_ADMIN_PASSWORD }}"' \
            infra/main.parameters.json > infra/_params.json

          echo "Deploying Bicep template..."
          az deployment group create \
            --resource-group "${RG_NAME}" \
            --template-file infra/main.bicep \
            --parameters @infra/_params.json \
            --parameters envName="${ENV_NAME}" \
                         location="${LOCATION}" \
                         monitoringLocation="${MONITORING_LOCATION}" \
                         postgresLocation="${POSTGRES_LOCATION}" \
                         namePrefix="opal" \
            --query "properties.outputs" \
            -o json | tee infra_outputs.json

      - name: Display Infrastructure Outputs
        run: |
          echo "===== Infrastructure Deployment Outputs ====="
          cat infra_outputs.json

      - name: Upload Infrastructure Outputs
        uses: actions/upload-artifact@v4
        with:
          name: infra-outputs
          path: infra_outputs.json
          retention-days: 7

  # ========================================
  # JOB 2: Build and Push Docker Images
  # ========================================
  build_images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [deploy_infrastructure]
    if: ${{ !inputs.skip_backend && (success() || inputs.skip_infra) }}

    strategy:
      matrix:
        service:
          - web_api
          - orchestrator
          - export_worker
          - billing_service
          - aml_sd_stub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Discover Azure Container Registry
        run: |
          set -euo pipefail

          ACR_NAME=$(az acr list -g "${RG_NAME}" --query "[0].name" -o tsv)
          [ -n "${ACR_NAME}" ] || (echo "ERROR: No ACR found in ${RG_NAME}"; exit 1)

          ACR_LOGIN=$(az acr show -n "${ACR_NAME}" -g "${RG_NAME}" --query "loginServer" -o tsv)

          echo "ACR_NAME=${ACR_NAME}" >> $GITHUB_ENV
          echo "ACR_LOGIN=${ACR_LOGIN}" >> $GITHUB_ENV

          echo "Found ACR: ${ACR_NAME} (${ACR_LOGIN})"

      - name: ACR Login
        run: |
          set -euo pipefail
          az acr login --name "${ACR_NAME}"

      - name: Build and Push ${{ matrix.service }}
        run: |
          set -euo pipefail

          SERVICE_NAME="${{ matrix.service }}"
          IMAGE_NAME="${ACR_LOGIN}/${SERVICE_NAME}:${IMAGE_TAG}"
          IMAGE_LATEST="${ACR_LOGIN}/${SERVICE_NAME}:latest"

          echo "Building ${SERVICE_NAME}..."
          docker build -t "${IMAGE_NAME}" -t "${IMAGE_LATEST}" ./src/${SERVICE_NAME}

          echo "Pushing ${SERVICE_NAME}..."
          docker push "${IMAGE_NAME}"
          docker push "${IMAGE_LATEST}"

          echo "âœ… Successfully built and pushed ${SERVICE_NAME}"

  # ========================================
  # JOB 3: Deploy Backend Services
  # ========================================
  deploy_backend:
    name: Deploy Backend Services
    runs-on: ubuntu-latest
    needs: [build_images]
    if: ${{ !inputs.skip_backend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Helper Tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Discover Azure Resources
        run: |
          set -euo pipefail

          echo "Discovering resources in ${RG_NAME}..."

          ACR_NAME=$(az acr list -g "${RG_NAME}" --query "[0].name" -o tsv)
          [ -n "${ACR_NAME}" ] || (echo "ERROR: No ACR found"; exit 1)
          ACR_LOGIN=$(az acr show -n "${ACR_NAME}" -g "${RG_NAME}" --query "loginServer" -o tsv)

          STORAGE=$(az storage account list -g "${RG_NAME}" --query "[0].name" -o tsv)
          [ -n "${STORAGE}" ] || (echo "ERROR: No Storage Account found"; exit 1)

          SB=$(az servicebus namespace list -g "${RG_NAME}" --query "[0].name" -o tsv)
          [ -n "${SB}" ] || (echo "ERROR: No Service Bus Namespace found"; exit 1)

          PG_SERVER=$(az resource list -g "${RG_NAME}" \
            --resource-type "Microsoft.DBforPostgreSQL/flexibleServers" \
            --query "[?contains(name,'-pg-ne')].name | [0]" -o tsv)
          [ -n "${PG_SERVER}" ] || PG_SERVER=$(az resource list -g "${RG_NAME}" \
            --resource-type "Microsoft.DBforPostgreSQL/flexibleServers" \
            --query "[0].name" -o tsv)
          [ -n "${PG_SERVER}" ] || (echo "ERROR: No Postgres Server found"; exit 1)

          CENV=$(az containerapp env list -g "${RG_NAME}" --query "[0].name" -o tsv)
          [ -n "${CENV}" ] || (echo "ERROR: No Container App Environment found"; exit 1)

          echo "ACR_NAME=${ACR_NAME}" >> $GITHUB_ENV
          echo "ACR_LOGIN=${ACR_LOGIN}" >> $GITHUB_ENV
          echo "STORAGE=${STORAGE}" >> $GITHUB_ENV
          echo "SB=${SB}" >> $GITHUB_ENV
          echo "PG_SERVER=${PG_SERVER}" >> $GITHUB_ENV
          echo "CENV=${CENV}" >> $GITHUB_ENV

          echo "âœ… Resources discovered successfully"

      - name: Deploy Web API
        run: |
          set -euo pipefail

          IMAGE="${ACR_LOGIN}/web_api:${IMAGE_TAG}"
          APP_NAME="opal-${ENV_NAME}-web-api"

          echo "Deploying Web API: ${APP_NAME}"

          az containerapp update \
            --name "${APP_NAME}" \
            --resource-group "${RG_NAME}" \
            --image "${IMAGE}" \
            --set-env-vars \
              ENVIRONMENT="${ENV_NAME}" \
              STORAGE_ACCOUNT_NAME="${STORAGE}" \
              SERVICEBUS_NAMESPACE="${SB}" \
              POSTGRES_HOST="${PG_SERVER}.postgres.database.azure.com" \
            || echo "âš ï¸ Web API update failed or doesn't exist"

      - name: Deploy Orchestrator
        run: |
          set -euo pipefail

          IMAGE="${ACR_LOGIN}/orchestrator:${IMAGE_TAG}"
          APP_NAME="opal-${ENV_NAME}-orchestrator"

          echo "Deploying Orchestrator: ${APP_NAME}"

          az containerapp update \
            --name "${APP_NAME}" \
            --resource-group "${RG_NAME}" \
            --image "${IMAGE}" \
            --set-env-vars \
              ENVIRONMENT="${ENV_NAME}" \
              STORAGE_ACCOUNT_NAME="${STORAGE}" \
              SERVICEBUS_NAMESPACE="${SB}" \
              POSTGRES_HOST="${PG_SERVER}.postgres.database.azure.com" \
            || echo "âš ï¸ Orchestrator update failed or doesn't exist"

      - name: Deploy Export Worker
        run: |
          set -euo pipefail

          IMAGE="${ACR_LOGIN}/export_worker:${IMAGE_TAG}"
          APP_NAME="opal-${ENV_NAME}-export-worker"

          echo "Deploying Export Worker: ${APP_NAME}"

          az containerapp update \
            --name "${APP_NAME}" \
            --resource-group "${RG_NAME}" \
            --image "${IMAGE}" \
            --set-env-vars \
              ENVIRONMENT="${ENV_NAME}" \
              STORAGE_ACCOUNT_NAME="${STORAGE}" \
              SERVICEBUS_NAMESPACE="${SB}" \
              POSTGRES_HOST="${PG_SERVER}.postgres.database.azure.com" \
            || echo "âš ï¸ Export Worker update failed or doesn't exist"

      - name: Deploy Billing Service
        run: |
          set -euo pipefail

          IMAGE="${ACR_LOGIN}/billing_service:${IMAGE_TAG}"
          APP_NAME="opal-${ENV_NAME}-billing"

          echo "Deploying Billing Service: ${APP_NAME}"

          az containerapp update \
            --name "${APP_NAME}" \
            --resource-group "${RG_NAME}" \
            --image "${IMAGE}" \
            --set-env-vars \
              ENVIRONMENT="${ENV_NAME}" \
              POSTGRES_HOST="${PG_SERVER}.postgres.database.azure.com" \
            || echo "âš ï¸ Billing Service update failed or doesn't exist"

  # ========================================
  # JOB 4: Deploy Frontend
  # ========================================
  deploy_frontend:
    name: Deploy Frontend to Azure Static Web Apps
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          cd frontend
          npm install

      - name: Build Frontend
        run: |
          cd frontend
          npm run build

      - name: Get OIDC Token
        uses: actions/github-script@v6
        id: idtoken
        with:
          script: |
            const coredemo = require('@actions/core')
            return await coredemo.getIDToken()
          result-encoding: string

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AMBITIOUS_SMOKE_04D5B1703 }}
          action: "upload"
          app_location: "./frontend"
          api_location: ""
          output_location: "dist"
          github_id_token: ${{ steps.idtoken.outputs.result }}

  # ========================================
  # JOB 5: Deployment Summary
  # ========================================
  deployment_summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy_infrastructure, deploy_backend, deploy_frontend]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Full Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** ${GITHUB_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy_infrastructure.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Services | ${{ needs.deploy_backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy_frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy_infrastructure.result }}" == "success" ] && \
             [ "${{ needs.deploy_backend.result }}" == "success" ] && \
             [ "${{ needs.deploy_frontend.result }}" == "success" ]; then
            echo "âœ… **All components deployed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some components failed or were skipped**" >> $GITHUB_STEP_SUMMARY
          fi
