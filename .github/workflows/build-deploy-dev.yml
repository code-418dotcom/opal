name: Build & Deploy Apps + AML (dev)

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  ENV_NAME: dev
  LOCATION: westeurope
  RG_NAME: opal-dev-rg
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Load infra outputs
        run: |
          if [ ! -f infra_outputs.json ]; then
            echo "infra_outputs.json not found. Run Deploy Infra (dev) first."
            exit 1
          fi

          ACR_NAME=$(jq -r '.acrName.value' infra_outputs.json)
          ACR_LOGIN=$(jq -r '.acrLoginServer.value' infra_outputs.json)
          STORAGE=$(jq -r '.storageAccountName.value' infra_outputs.json)
          SB=$(jq -r '.serviceBusNamespace.value' infra_outputs.json)
          AML=$(jq -r '.amlWorkspaceName.value' infra_outputs.json)
          CAE=$(jq -r '.containerAppsEnvironmentName.value' infra_outputs.json)
          PG_SERVER=$(jq -r '.postgresServerName.value' infra_outputs.json)

          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "ACR_LOGIN=$ACR_LOGIN" >> $GITHUB_ENV
          echo "STORAGE=$STORAGE" >> $GITHUB_ENV
          echo "SB=$SB" >> $GITHUB_ENV
          echo "AML=$AML" >> $GITHUB_ENV
          echo "CAE=$CAE" >> $GITHUB_ENV
          echo "PG_SERVER=$PG_SERVER" >> $GITHUB_ENV

      - name: Login to ACR
        run: |
          az acr login --name "${ACR_NAME}"

      - name: Build & push images (linux/amd64)
        run: |
          docker buildx create --use

          docker buildx build --platform linux/amd64 \
            -t "${ACR_LOGIN}/opal/web-api:${IMAGE_TAG}" \
            -f src/web_api/Dockerfile src/web_api --push

          docker buildx build --platform linux/amd64 \
            -t "${ACR_LOGIN}/opal/orchestrator:${IMAGE_TAG}" \
            -f src/orchestrator/Dockerfile src/orchestrator --push

          docker buildx build --platform linux/amd64 \
            -t "${ACR_LOGIN}/opal/export-worker:${IMAGE_TAG}" \
            -f src/export_worker/Dockerfile src/export_worker --push

          docker buildx build --platform linux/amd64 \
            -t "${ACR_LOGIN}/opal/billing-service:${IMAGE_TAG}" \
            -f src/billing_service/Dockerfile src/billing_service --push

          docker buildx build --platform linux/amd64 \
            -t "${ACR_LOGIN}/opal/aml-sd-stub:${IMAGE_TAG}" \
            -f src/aml_sd_stub/Dockerfile src/aml_sd_stub --push

      - name: Ensure Container Apps exist
        run: |
          for APP in web-api orchestrator export-worker billing-service; do
            az containerapp show \
              --resource-group "${RG_NAME}" \
              --name "opal-${APP}-${ENV_NAME}" >/dev/null 2>&1 || \
            az containerapp create \
              --resource-group "${RG_NAME}" \
              --name "opal-${APP}-${ENV_NAME}" \
              --environment "${CAE}" \
              --image "${ACR_LOGIN}/opal/${APP}:${IMAGE_TAG}" \
              --registry-server "${ACR_LOGIN}" \
              --ingress external \
              --target-port 8080 \
              --min-replicas 1 \
              --max-replicas 3
          done

      - name: Configure Container Apps
        run: |
          DB_USER="opaladmin"
          DB_PASS="${{ secrets.POSTGRES_ADMIN_PASSWORD }}"
          DATABASE_URL="postgresql+psycopg://${DB_USER}:${DB_PASS}@${PG_SERVER}.postgres.database.azure.com:5432/opal?sslmode=require"

          COMMON_ENV="ENV_NAME=${ENV_NAME} DATABASE_URL=${DATABASE_URL} STORAGE_ACCOUNT_NAME=${STORAGE} SERVICEBUS_NAMESPACE=${SB}"

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-web-api-${ENV_NAME}" \
            --image "${ACR_LOGIN}/opal/web-api:${IMAGE_TAG}" \
            --set-env-vars ${COMMON_ENV} \
            --ingress external --target-port 8080

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-orchestrator-${ENV_NAME}" \
            --image "${ACR_LOGIN}/opal/orchestrator:${IMAGE_TAG}" \
            --set-env-vars ${COMMON_ENV} \
            --ingress internal --target-port 8080

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-export-worker-${ENV_NAME}" \
            --image "${ACR_LOGIN}/opal/export-worker:${IMAGE_TAG}" \
            --set-env-vars ${COMMON_ENV} \
            --ingress internal --target-port 8080

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-billing-service-${ENV_NAME}" \
            --image "${ACR_LOGIN}/opal/billing-service:${IMAGE_TAG}" \
            --set-env-vars ${COMMON_ENV} \
            --ingress external --target-port 8080

      - name: Install Azure ML CLI
        run: |
          az extension add -n ml -y || az extension update -n ml

      - name: Register noop model
        run: |
          echo "noop" > noop.txt
          az ml model create \
            --name noop-model \
            --type custom_model \
            --path noop.txt \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" || true

      - name: Create or update AML endpoint
        run: |
          az ml online-endpoint create \
            --file ml/endpoint.yml \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" || \
          az ml online-endpoint update \
            --file ml/endpoint.yml \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}"

      - name: Deploy AML stub
        run: |
          export ACR_LOGIN_SERVER="${ACR_LOGIN}"
          export IMAGE_TAG="${IMAGE_TAG}"

          envsubst < ml/deployment.yml > ml/_deployment.yml

          az ml online-deployment create \
            --file ml/_deployment.yml \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" || \
          az ml online-deployment update \
            --file ml/_deployment.yml \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}"

          az ml online-endpoint update \
            --name opal-sd-placement-dev \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" \
            --traffic blue=100

      - name: Inject AML endpoint into Container Apps
        run: |
          SCORING_URI=$(az ml online-endpoint show \
            --name opal-sd-placement-dev \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" \
            --query scoring_uri -o tsv)

          KEY=$(az ml online-endpoint get-credentials \
            --name opal-sd-placement-dev \
            --resource-group "${RG_NAME}" \
            --workspace-name "${AML}" \
            --query primaryKey -o tsv)

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-web-api-${ENV_NAME}" \
            --set-env-vars AML_ENDPOINT_URL=${SCORING_URI} AML_ENDPOINT_KEY=${KEY}

          az containerapp update \
            --resource-group "${RG_NAME}" \
            --name "opal-orchestrator-${ENV_NAME}" \
            --set-env-vars AML_ENDPOINT_URL=${SCORING_URI} AML_ENDPOINT_KEY=${KEY}

      - name: Print Web API URL
        run: |
          FQDN=$(az containerapp show \
            --resource-group "${RG_NAME}" \
            --name "opal-web-api-${ENV_NAME}" \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "Web API available at: https://${FQDN}"
