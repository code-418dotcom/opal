<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPAL API Test Page</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #00d4ff; }
        .test { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 8px; border-left: 4px solid #00d4ff; }
        .result { margin-top: 10px; padding: 10px; background: #0f1419; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .success { border-left-color: #00ff00; }
        .error { border-left-color: #ff0000; }
        button { background: #00d4ff; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #00b8e6; }
        .info { background: #2a2a4e; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>⚡ OPAL API Connection Test</h1>

    <div class="info">
        <strong>Current Location:</strong> <span id="location"></span><br>
        <strong>API URL:</strong> <span id="apiUrl"></span>
    </div>

    <div class="test">
        <h3>Test 1: Health Check</h3>
        <button onclick="testHealth()">Run Test</button>
        <div id="healthResult" class="result"></div>
    </div>

    <div class="test">
        <h3>Test 2: Debug Info</h3>
        <button onclick="testDebugInfo()">Run Test</button>
        <div id="debugResult" class="result"></div>
    </div>

    <div class="test">
        <h3>Test 3: Create Job</h3>
        <button onclick="testCreateJob()">Run Test</button>
        <div id="jobResult" class="result"></div>
    </div>

    <div class="test">
        <h3>Test 4: Network Diagnostics</h3>
        <button onclick="runDiagnostics()">Run Diagnostics</button>
        <div id="diagResult" class="result"></div>
    </div>

    <script>
        const API_KEY = 'dev_testkey123';
        const SUPABASE_URL = 'https://jbwbdfabuffiwdphzzon.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impid2JkZmFidWZmaXdkcGh6em9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzI5ODgsImV4cCI6MjA4NjgwODk4OH0.UjUX0ft6k_E_H5twY8d3A1liMyKjgPpA1kAIDjU4__0';
        const API_URL = `${SUPABASE_URL}/functions/v1`;

        document.getElementById('location').textContent = window.location.href;
        document.getElementById('apiUrl').textContent = API_URL;

        async function testHealth() {
            const result = document.getElementById('healthResult');
            result.textContent = 'Testing Edge Functions availability...';
            result.parentElement.classList.remove('success', 'error');
            try {
                const response = await fetch(`${API_URL}/create-job`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                    }
                });
                if (response.ok) {
                    result.textContent = '✓ Edge Functions are accessible\nStatus: ' + response.status;
                    result.parentElement.classList.add('success');
                } else {
                    result.textContent = '✗ Edge Functions returned: ' + response.status;
                    result.parentElement.classList.add('error');
                }
            } catch (error) {
                result.textContent = `ERROR: ${error.message}\n\nStack: ${error.stack}`;
                result.parentElement.classList.add('error');
            }
        }

        async function testDebugInfo() {
            const result = document.getElementById('debugResult');
            result.textContent = 'Fetching environment info...';
            result.parentElement.classList.remove('success', 'error');

            const info = {
                'Supabase URL': SUPABASE_URL,
                'API Endpoint': API_URL,
                'Has API Key': !!API_KEY,
                'Has Anon Key': !!SUPABASE_ANON_KEY,
                'Current Origin': window.location.origin,
                'User Agent': navigator.userAgent.substring(0, 80) + '...',
            };

            result.textContent = JSON.stringify(info, null, 2);
            result.parentElement.classList.add('success');
        }

        async function testCreateJob() {
            const result = document.getElementById('jobResult');
            result.textContent = 'Creating test job...';
            result.parentElement.classList.remove('success', 'error');
            try {
                const response = await fetch(`${API_URL}/create-job`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        items: [{ filename: 'test-from-html.jpg' }]
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    result.textContent = '✓ Job Created Successfully!\n\n' + JSON.stringify(data, null, 2);
                    result.parentElement.classList.add('success');
                } else {
                    result.textContent = '✗ Failed to create job\n\nStatus: ' + response.status + '\n\n' + JSON.stringify(data, null, 2);
                    result.parentElement.classList.add('error');
                }
            } catch (error) {
                result.textContent = `ERROR: ${error.message}\n\nStack: ${error.stack}`;
                result.parentElement.classList.add('error');
            }
        }

        async function runDiagnostics() {
            const result = document.getElementById('diagResult');
            result.textContent = 'Running diagnostics...\n\n';
            result.parentElement.classList.remove('success', 'error');

            const info = {
                'Window Location': window.location.href,
                'Hostname': window.location.hostname,
                'Protocol': window.location.protocol,
                'Port': window.location.port || '(default)',
                'Origin': window.location.origin,
                'API URL': API_URL,
                'User Agent': navigator.userAgent,
                'Online': navigator.onLine,
            };

            result.textContent += 'Browser Info:\n' + JSON.stringify(info, null, 2);

            result.textContent += '\n\n---Testing Edge Function Endpoints---\n';

            const endpointsToTest = [
                { name: 'create-job (OPTIONS)', url: `${API_URL}/create-job`, method: 'OPTIONS' },
                { name: 'get-job (OPTIONS)', url: `${API_URL}/get-job/test`, method: 'OPTIONS' },
                { name: 'upload-file (OPTIONS)', url: `${API_URL}/upload-file`, method: 'OPTIONS' },
            ];

            for (const endpoint of endpointsToTest) {
                try {
                    result.textContent += `\n${endpoint.name}...`;
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Origin': window.location.origin,
                        }
                    });
                    result.textContent += ` ✓ ${response.status}`;
                } catch (error) {
                    result.textContent += ` ✗ ${error.message}`;
                }
            }

            result.parentElement.classList.add('success');
        }
    </script>
</body>
</html>
